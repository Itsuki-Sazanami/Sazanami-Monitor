<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JRæ±æ—¥æœ¬é‹è¡Œæƒ…å ± å¸¸æ™‚ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ (ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #ffffff; 
        }
        .monitor-card {
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); 
            border-left: 5px solid #d1d5db; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å·¦æ ç·š */
            transition: all 0.15s ease-in-out;
        }
        /* é‹è¡Œæƒ…å ±ã‚¢ã‚¤ãƒ†ãƒ ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .info-item {
             border-left: 4px solid;
             background-color: #ffffff;
             padding: 12px;
             border-radius: 6px;
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        /* è·¯ç·šåã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¼·èª¿ã‚’ãªãã™ */
        .railway-name, .status-text {
            font-weight: 500; 
            color: #1f2937; 
            margin-right: 4px; 
            padding: 0;
            white-space: nowrap; 
            font-size: 1em; 
        }
        /* è©³ç´°æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .detail-text {
            color: #4b5563; 
            font-size: 0.95em;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">JRæ±æ—¥æœ¬é‹è¡Œæƒ…å ± å¸¸æ™‚ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="text-gray-500">é‹è¡Œã«å½±éŸ¿ã™ã‚‹æƒ…å ±ã¨å®šå‹çš„ãªãŠçŸ¥ã‚‰ã›ã®ã¿ã‚’è¡¨ç¤ºã€‚å¹³å¸¸é‹è»¢ã®è·¯ç·šã¯éè¡¨ç¤ºã«ã—ã¦ã„ã¾ã™ã€‚</p>
            <p class="text-gray-500">âš ï¸éå…¬å¼æƒ…å ±ã®ãŸã‚ã€æ­£ç¢ºãªé‹è¡Œæƒ…å ±ã¯JRæ±æ—¥æœ¬ã‚¢ãƒ—ãƒªç­‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚</p>
            <p class="text-gray-500">æš«å®šå®Ÿè£…ä¸­:ç¯ ãƒäº•ç·š,å¤§ç³¸ç·š,ä¿¡è¶Šæœ¬ç·š,é£¯å±±ç·š</p>
        </header>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« -->
        <div id="status-panel" class="monitor-card rounded-lg p-4 mb-6 transition duration-300 border-l-4 border-gray-400">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg id="status-icon" class="w-6 h-6 mr-3 text-gray-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0l3-3m-3 3l3 3"></path></svg>
                    <span id="status-text" class="text-lg font-semibold text-gray-700">åˆæœŸåŒ–ä¸­...</span>
                </div>
                <span id="last-updated" class="text-sm text-gray-500">æœ€çµ‚æ›´æ–°: -</span>
            </div>
            <p id="next-update-info" class="text-xs mt-1 text-gray-400">æ¬¡å›æ›´æ–°ã¾ã§: -</p>
        </div>

        <!-- é‹è¡Œæƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ (é‹ä¼‘ãƒ»è¦‹åˆã‚ã›ãƒ»é…å»¶ãƒ»ä¹±ã‚Œ - å®šå‹æ–‡é™¤ã) -->
        <div id="info-display" class="space-y-4 mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">ğŸš¨ é‹è¡Œæƒ…å ±</h2>
            <div id="realtime-results" class="space-y-2 p-4 border rounded-lg bg-gray-50 border-gray-200">
                <p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
            </div>
        </div>
        
        <!-- ãŠçŸ¥ã‚‰ã›è¡¨ç¤ºã‚¨ãƒªã‚¢ (å®šå‹æ–‡ã€ä¿å®ˆå·¥äº‹ã€å¤–éƒ¨ãƒªãƒ³ã‚¯æƒ…å ±ã®ã¿) -->
        <div id="notice-display" class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">ğŸ“¢ ãŠçŸ¥ã‚‰ã›ï¼ˆå·¥äº‹æƒ…å ±ãªã©ï¼‰</h2>
            <div id="notice-results" class="space-y-2 p-4 border rounded-lg bg-gray-50 border-gray-200">
                <p class="text-gray-500">ç¾åœ¨ã€ç‰¹ç­†ã™ã¹ããŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
        </div>

        <!-- ç›£è¦–è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰ -->
        <div class="mt-8 p-4 bg-gray-100 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">ç›£è¦–è¨­å®š</h3>
            <div class="flex items-center space-x-4">
                <label for="interval-select" class="text-sm text-gray-600">æ›´æ–°é–“éš”:</label>
                <select id="interval-select" class="p-2 border rounded-md">
                    <option value="15000" selected>15ç§’</option>
                    <option value="30000">30ç§’</option>
                    <option value="60000">60ç§’ (1åˆ†)</option>
                    <option value="120000">120ç§’ (2åˆ†)</option>
                </select>
                <button id="toggle-monitor" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150">ç›£è¦–åœæ­¢</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // ğŸ”‘ è¨­å®šæƒ…å ± (ãƒãƒ£ãƒ¬ãƒ³ã‚¸APIã¨èªè¨¼ã‚­ãƒ¼ã‚’è¨­å®š)
        // =================================================================
        const CONSUMER_KEY = "mkgexd43rtmsoiw9mlp4ezgwfc1p0ekyh0ltya28ta5bc3aaus95d1tbomcgtdyp"; 

        // JRæ±æ—¥æœ¬ã‚¢ã‚¤ã‚¹ãƒ†ã‚¤ã‚·ãƒ§ãƒ³ã‚ºã®é‹è¡Œæƒ…å ±APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (ãƒãƒ£ãƒ¬ãƒ³ã‚¸API)
        const TRAIN_INFO_API_URL = "https://api-challenge.odpt.org/api/v4/odpt:TrainInformation?odpt:operator=odpt.Operator:jre-is";
        
        // =================================================================
        // ğŸ—ºï¸ è·¯ç·šåãƒãƒƒãƒ”ãƒ³ã‚° (APIã®ID â†’ æ—¥æœ¬èªå)
        // =================================================================
        const RAILWAY_NAME_MAP = {
            "JR-East.Tokaido": "æ±æµ·é“ç·š", "JR-East.Yokosuka": "æ¨ªé ˆè³€ç·š", "JR-East.ShonanShinjuku": "æ¹˜å—æ–°å®¿ãƒ©ã‚¤ãƒ³",
            "JR-East.KeihinTohokuNegishi": "äº¬æµœæ±åŒ—ãƒ»æ ¹å²¸ç·š", "JR-East.Yokohama": "æ¨ªæµœç·š", "JR-East.Nambu": "å—æ­¦ç·š",
            "JR-East.NambuBranch": "å—æ­¦ç·šæµœå·å´æ”¯ç·š", "JR-East.Yamanote": "å±±æ‰‹ç·š", "JR-East.Chuo": "ä¸­å¤®æœ¬ç·š",
            "JR-East.ChuoRapid": "ä¸­å¤®ç·šå¿«é€Ÿé›»è»Š", "JR-East.ChuoSobuLocal": "ä¸­å¤®ãƒ»ç·æ­¦ç·šå„é§…åœè»Š", "JR-East.SobuRapid": "ç·æ­¦å¿«é€Ÿç·š",
            "JR-East.Ome": "é’æ¢…ç·š", "JR-East.Itsukaichi": "äº”æ—¥å¸‚ç·š", "JR-East.Utsunomiya": "å®‡éƒ½å®®ç·š", "JR-East.Takasaki": "é«˜å´ç·š",
            "JR-East.SaikyoKawagoe": "åŸ¼äº¬ç·šãƒ»å·è¶Šç·š", "JR-East.Kawagoe": "å·è¶Šç·š", "JR-East.SotetsuDirect": "ç›¸é‰„ç·šç›´é€šåˆ—è»Š",
            "JR-East.Joban": "å¸¸ç£ç·š", "JR-East.JobanRapid": "å¸¸ç£ç·šå¿«é€Ÿé›»è»Š", "JR-East.JobanLocal": "å¸¸ç£ç·šå„é§…åœè»Š",
            "JR-East.Keiyo": "äº¬è‘‰ç·š", "JR-East.Musashino": "æ­¦è”µé‡ç·š", "JR-East.Sagami": "ç›¸æ¨¡ç·š", "JR-East.Uchibo": "å†…æˆ¿ç·š",
            "JR-East.Sotobo": "å¤–æˆ¿ç·š", "JR-East.Sobu": "ç·æ­¦æœ¬ç·š", "JR-East.Nikko": "æ—¥å…‰ç·š", "JR-East.Karasuyama": "çƒå±±ç·š",
            "JR-East.Tsurumi": "é¶´è¦‹ç·š", "JR-East.TsurumiUmiShibauraBranch": "é¶´è¦‹ç·šæµ·èŠæµ¦æ”¯ç·š", "JR-East.TsurumiOkawaBranch": "é¶´è¦‹ç·šå¤§å·æ”¯ç·š",
            "JR-East.Ito": "ä¼Šæ±ç·š", "JR-East.Hachiko": "å…«é«˜ç·š", "JR-East.Mito": "æ°´æˆ¸ç·š", "JR-East.Suigun": "æ°´éƒ¡ç·š",
            "JR-East.SuigunBranch": "æ°´éƒ¡ç·šå¸¸é™¸å¤ªç”°æ”¯ç·š", "JR-East.Narita": "æˆç”°ç·š", "JR-East.NaritaAirportBranch": "æˆç”°ç·šç©ºæ¸¯æ”¯ç·š",
            "JR-East.NaritaAbikoBranch": "æˆç”°ç·šæˆ‘å­«å­æ”¯ç·š", "JR-East.Kashima": "é¹¿å³¶ç·š", "JR-East.Togane": "æ±é‡‘ç·š",
            "JR-East.Kururi": "ä¹…ç•™é‡Œç·š", "JR-East.ChuoTatsunoBranch": "ä¸­å¤®æœ¬ç·šè¾°é‡æ”¯ç·š", "JR-East.TohokuShinkansen": "æ±åŒ—æ–°å¹¹ç·š",
            "JR-East.JoetsuShinkansen": "ä¸Šè¶Šæ–°å¹¹ç·š", "JR-East.HokurikuShinkansen": "åŒ—é™¸æ–°å¹¹ç·š", "JR-East.YamagataShinkansen": "å±±å½¢æ–°å¹¹ç·š",
            "JR-East.AkitaShinkansen": "ç§‹ç”°æ–°å¹¹ç·š", "JR-East.BanetsuWest": "ç£è¶Šè¥¿ç·š", "JR-East.Ou": "å¥¥ç¾½æœ¬ç·š",
            "JR-East.Hachinohe": "å…«æˆ¸ç·š", "JR-East.Yamada": "å±±ç”°ç·š", "JR-East.Hanawa": "èŠ±è¼ªç·š", "JR-East.Tsugaru": "æ´¥è»½ç·š",
            "JR-East.Oga": "ç”·é¹¿ç·š", "JR-East.Aterazawa": "å·¦æ²¢ç·š", "JR-East.Kesennuma": "æ°—ä»™æ²¼ç·š", "JR-East.Ishinomaki": "çŸ³å·»ç·š",
            "JR-East.RikuEast": "é™¸ç¾½æ±ç·š", "JR-East.Uetsu": "ç¾½è¶Šæœ¬ç·š", "JR-East.RikuWest": "é™¸ç¾½è¥¿ç·š", "JR-East.Echigo": "è¶Šå¾Œç·š",
            "JR-East.Tohoku": "æ±åŒ—æœ¬ç·š", "JR-East.BanetsuEast": "ç£è¶Šæ±ç·š", "JR-East.OuYamagata": "å¥¥ç¾½æœ¬ç·šå±±å½¢ã‚¨ãƒªã‚¢",
            "JR-East.Senseki": "ä»™çŸ³ç·š", "JR-East.Senzan": "ä»™å±±ç·š", "JR-East.Ofunato": "å¤§èˆ¹æ¸¡ç·š", "JR-East.Kitakami": "åŒ—ä¸Šç·š",
            "JR-East.Kamaishi": "é‡œçŸ³ç·š", "JR-East.Ominato": "å¤§æ¹Šç·š", "JR-East.Tazawako": "ç”°æ²¢æ¹–ç·š", "JR-East.Gono": "äº”èƒ½ç·š",
            "JR-East.Tadami": "åªè¦‹ç·š", "JR-East.SensekiTohoku": "ä»™çŸ³æ±åŒ—ãƒ©ã‚¤ãƒ³", "JR-East.Hakushin": "ç™½æ–°ç·š",
            "JR-East.Yahiko": "å¼¥å½¦ç·š", "JR-East.Shinonoi": "ç¯ ãƒäº•ç·š", "JR-East.Oito": "å¤§ç³¸ç·š", "JR-East.Shinetsu": "ä¿¡è¶Šæœ¬ç·š",
            "JR-East.Agatsuma": "å¾å¦»ç·š", "JR-East.Ryomo": "ä¸¡æ¯›ç·š", "JR-East.Joetsu": "ä¸Šè¶Šç·š", "JR-East.Koumi": "å°æµ·ç·š",
            "JR-East.Iiyama": "é£¯å±±ç·š", "JR-East.Yonesaka": "ç±³å‚ç·š",
        };
        
        // âŒ é€šçŸ¥é™¤å¤–è·¯ç·š è¨­å®šãƒªã‚¹ãƒˆ (æ—¥æœ¬èªå)
        const EXCLUDED_RAILWAYS_JA = [
        "ä¹…ç•™é‡Œç·š","ç£è¶Šè¥¿ç·š","å¥¥ç¾½æœ¬ç·š","å…«æˆ¸ç·š","å±±ç”°ç·š",
        "èŠ±è¼ªç·š","æ´¥è»½ç·š","å¤§æ¹Šç·š","ç”·é¹¿ç·š","å·¦æ²¢ç·š","æ°—ä»™æ²¼ç·š",
        "çŸ³å·»ç·š","é™¸ç¾½æ±ç·š","ç¾½è¶Šæœ¬ç·š","é™¸ç¾½è¥¿ç·š","è¶Šå¾Œç·š",
        "æ±åŒ—æœ¬ç·š","ç£è¶Šæ±ç·š","å¥¥ç¾½æœ¬ç·šå±±å½¢ã‚¨ãƒªã‚¢","ä»™çŸ³ç·š","ä»™å±±ç·š",
        "å¤§èˆ¹æ¸¡ç·š","åŒ—ä¸Šç·š","é‡œçŸ³ç·š","ç”°æ²¢æ¹–ç·š","äº”èƒ½ç·š","åªè¦‹ç·š",
        "ä»™çŸ³æ±åŒ—ãƒ©ã‚¤ãƒ³","ç™½æ–°ç·š","å¼¥å½¦ç·š",
        "å¾å¦»ç·š","ä¸¡æ¯›ç·š","ä¸Šè¶Šç·š","å°æµ·ç·š","ç±³å‚ç·š","æ°´éƒ¡ç·š","æ°´éƒ¡ç·šå¸¸é™¸å¤ªç”°æ”¯ç·š","å…«é«˜ç·š",
        ];
        //"ç¯ ãƒäº•ç·š","å¤§ç³¸ç·š","ä¿¡è¶Šæœ¬ç·š","é£¯å±±ç·š",
        
        // =================================================================
        // ğŸ› ï¸ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // =================================================================

        /**
         * APIã®è·¯ç·šIDï¼ˆodpt:Railway:JR-East.XXXï¼‰ã‚’æ—¥æœ¬èªåã«å¤‰æ›ã—ã¾ã™ã€‚
         */
        function getJapaneseRailwayName(railwayId) {
            const fullIdKey = railwayId.replace('odpt.Railway:', ''); 
            const cleanIdKey = fullIdKey.replace('JR-East.', '');
            
            return RAILWAY_NAME_MAP[fullIdKey] || RAILWAY_NAME_MAP[cleanIdKey] || cleanIdKey || 'ä¸æ˜ãªè·¯ç·š';
        }

        /**
         * é‹è¡Œæƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡ºãƒ»æ•´å½¢ã—ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«è¡¨ç¤ºã—ã¾ã™ã€‚
         * @param {boolean} isAlert - é‹è¡Œæƒ…å ±æ¬„ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆé‹è¡Œã«å½±éŸ¿ãŒã‚ã‚‹ï¼‰ã‹ã©ã†ã‹
         * @returns {string} æ•´å½¢ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸HTML
         */
        function formatTrainInfoMessage(railwayNameJa, infoTextJa, statusTextJa, isAlert) {
            
            // 1. é‹è¡ŒçŠ¶æ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºå®š
            let displayStatus = statusTextJa || (isAlert ? "é‹è¡Œæƒ…å ±" : "æƒ…å ±ã‚ã‚Š");
            
            // 2. é‹è¡ŒçŠ¶æ³ã®åˆ¤å®šã¨ã‚¢ã‚¤ã‚³ãƒ³ãƒ»è‰²ã®è¨­å®š
            let icon = 'â„¹ï¸';
            let borderColorClass = 'border-gray-300'; 
            let iconColorClass = 'text-gray-500'; 
            
            // è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            const isCriticalText = infoTextJa.includes('é‹è»¢è¦‹åˆã‚ã›') || infoTextJa.includes('é‹ä¼‘');
            const isDelayText = infoTextJa.includes('é…ã‚Œ') || infoTextJa.includes('é…å»¶') || infoTextJa.includes('ä¹±ã‚Œ');

            if (isAlert) {
                // é‹è¡Œæƒ…å ±ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹å ´åˆ
                if (isCriticalText) {
                    icon = 'âŒï¸'; 
                    borderColorClass = 'border-red-600';
                    iconColorClass = 'text-red-700';
                    displayStatus = displayStatus.includes('é‹ä¼‘') ? 'é‹ä¼‘' : 'é‹è»¢è¦‹åˆã‚ã›';
                } else if (isDelayText) {
                    icon = 'âš ï¸'; 
                    borderColorClass = 'border-yellow-400';
                    iconColorClass = 'text-yellow-600';
                    displayStatus = displayStatus.includes('é…å»¶') ? 'é…å»¶' : 'ä¹±ã‚Œ';
                } else {
                     // isAlert=trueã ãŒãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰çŠ¶æ…‹ãŒèª­ã¿å–ã‚Œãªã„å ´åˆï¼ˆåŸºæœ¬ã¯ç™ºç”Ÿã—ãªã„ãŒèµ¤ã«è¨­å®šï¼‰
                    icon = 'â„¹ï¸';
                    borderColorClass = 'border-red-500';
                    iconColorClass = 'text-red-600';
                    displayStatus = statusTextJa || 'é‹è¡Œæƒ…å ±';
                }

            } else {
                 // ãŠçŸ¥ã‚‰ã›æ¬„ã«è¡¨ç¤ºã™ã‚‹å ´åˆ (isAlertãŒfalse: å®šå‹æ–‡ãªã©)
                if (infoTextJa.includes('ä¿å®ˆå·¥äº‹')) {
                    icon = 'ğŸš§';
                    borderColorClass = 'border-purple-300';
                    iconColorClass = 'text-purple-600';
                    displayStatus = 'å·¥äº‹æƒ…å ±';
                } else {
                    // ãã®ä»–ã®æƒ…å ±ï¼ˆå®šå‹æ–‡ã€å¤–éƒ¨ãƒªãƒ³ã‚¯ãªã©ï¼‰ã¯é’
                    icon = 'ğŸ“¢';
                    borderColorClass = 'border-blue-300';
                    iconColorClass = 'text-blue-500';
                    displayStatus = statusTextJa || 'ãŠçŸ¥ã‚‰ã›';
                }
            }

            // 3. HTMLãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ„ã¿ç«‹ã¦
            const messageHtml = `
                <div class="info-item ${borderColorClass} flex items-start text-sm">
                    <span class="mr-2 text-xl flex-shrink-0 ${iconColorClass}">${icon}</span>
                    <div class="flex-grow text-gray-800">
                        <span class="railway-name">${railwayNameJa}</span> 
                        <span class="status-text text-gray-500">(${displayStatus})</span> 
                        <span class="detail-text block mt-0.5">${infoTextJa}</span>
                    </div>
                </div>
            `;
            
            return messageHtml;
        }

        // =================================================================
        // ğŸ“¡ APIãƒ‡ãƒ¼ã‚¿å–å¾—ã¨å‡¦ç†
        // =================================================================

        let monitorIntervalId = null; 
        let isMonitoring = true;      
        let updateIntervalMs = 30000; 
        let lastUpdateTime = null;    

        /**
         * ODPTã®åˆ—è»Šé‹è¡Œæƒ…å ±APIã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        async function fetchAndUpdateTrainInfo() {
            if (!isMonitoring) {
                console.log("ç›£è¦–ãŒåœæ­¢ã—ã¦ã„ã¾ã™ã€‚");
                return;
            }

            // UIã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆå–å¾—ä¸­ï¼‰
            updateStatusUI("å–å¾—ä¸­...", "blue", true);
            
            const apiUrlWithKey = `${TRAIN_INFO_API_URL}&acl:consumerKey=${CONSUMER_KEY}`;
            const resultsDiv = document.getElementById('realtime-results');
            const noticeDiv = document.getElementById('notice-results');
            
            try {
                const response = await fetchWithRetry(apiUrlWithKey);
                
                if (!response.ok) {
                    throw new Error(`APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                let activeAlertsHtml = [];   // é‹è¡Œæƒ…å ±ï¼ˆé‹è¡Œå½±éŸ¿ã‚ã‚Šï¼‰ç”¨
                let activeNoticesHtml = [];  // ãŠçŸ¥ã‚‰ã›ï¼ˆå®šå‹æ–‡ãªã©ï¼‰ç”¨
                
                // é‹è¡Œæƒ…å ±ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é¡
                for (const item of data) {
                    const railwayId = item['odpt:railway'] || null;
                    const infoTextJa = item['odpt:trainInformationText'] ? item['odpt:trainInformationText']['ja'] : null;
                    const statusTextJa = item['odpt:trainInformationStatus'] ? item['odpt:trainInformationStatus']['ja'] : null;

                    // æ—¥æœ¬èªåã®ç¢ºå®š
                    let railwayNameJa = item['odpt:railwayTitle'] ? item['odpt:railwayTitle']['ja'] : null;
                    
                    if (!railwayNameJa && railwayId) {
                        railwayNameJa = getJapaneseRailwayName(railwayId);
                    } else if (!railwayNameJa) {
                        railwayNameJa = 'ä¸æ˜ãªè·¯ç·š';
                    }

                    // é™¤å¤–ãƒªã‚¹ãƒˆã«ã‚ã‚‹è·¯ç·šã¯ç„¡è¦–
                    if (EXCLUDED_RAILWAYS_JA.includes(railwayNameJa) || !infoTextJa) {
                        continue;
                    }

                    // --- é‹è¡Œæƒ…å ±ã¨ã€ŒãŠçŸ¥ã‚‰ã›ã€ã®åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯ (å¹³å¸¸é‹è»¢é™¤å¤–) ---
                    
                    // å¹³å¸¸é‹è»¢ã®æƒ…å ±ã¯ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã—ãªã„
                    if (infoTextJa.includes('å¹³å¸¸é‹è»¢')) {
                        continue; 
                    }
                    
                    // ãŠçŸ¥ã‚‰ã›æ¬„ã«åˆ†é¡ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¿å®ˆå·¥äº‹ã€å¤–éƒ¨ãƒªãƒ³ã‚¯æƒ…å ±ãªã©)
                    const isNoticeKeyword = 
                        infoTextJa.includes('ä¿å®ˆå·¥äº‹') || 
                        infoTextJa.includes('è©³ã—ãã¯ï¼ªï¼²æ±æ—¥æœ¬ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸') || 
                        infoTextJa.includes('ãŠçŸ¥ã‚‰ã›æ¬„ã‹ã‚‰ã”è¦§ã„ãŸã ã‘ã¾ã™');

                    // 1. ãŠçŸ¥ã‚‰ã›æ¬„ã«åˆ†é¡ã™ã‚‹å ´åˆ (å®šå‹æ–‡ã‚„å·¥äº‹æƒ…å ±ãªã©)
                    if (isNoticeKeyword) {
                        const formattedMessageHtml = formatTrainInfoMessage(railwayNameJa, infoTextJa, statusTextJa, false);
                        activeNoticesHtml.push(formattedMessageHtml);
                    }
                    
                    // 2. é‹è¡Œæƒ…å ±ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ã¨ã—ã¦åˆ†é¡ã™ã‚‹å ´åˆ (ä¸Šè¨˜ä»¥å¤–ã€é‹è¡Œã«å½±éŸ¿ãŒã‚ã‚‹æƒ…å ±)
                    else {
                        const formattedMessageHtml = formatTrainInfoMessage(railwayNameJa, infoTextJa, statusTextJa, true);
                        activeAlertsHtml.push(formattedMessageHtml);
                    }
                }

                // UIæ›´æ–°
                lastUpdateTime = new Date();
                document.getElementById('last-updated').textContent = `æœ€çµ‚æ›´æ–°: ${lastUpdateTime.toLocaleTimeString('ja-JP')}`;
                
                // é‹è¡Œæƒ…å ±æ¬„ã®æ›´æ–° (é‹è¡Œã«å½±éŸ¿ãŒã‚ã‚‹æƒ…å ±ã®ã¿)
                if (activeAlertsHtml.length > 0) {
                    // æƒ…å ±ãŒã‚ã‚Œã°ã‚½ãƒ¼ãƒˆï¼ˆè·¯ç·šåé †ï¼‰
                    activeAlertsHtml.sort(); 
                    resultsDiv.innerHTML = activeAlertsHtml.join('');
                    resultsDiv.classList.remove('bg-gray-50', 'border-gray-200');
                    
                    // é‡å¤§ãªã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé‹ä¼‘ãƒ»è¦‹åˆã‚ã›ï¼‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const hasCriticalAlert = activeAlertsHtml.some(html => html.includes('border-red-600'));
                    
                    if (hasCriticalAlert) {
                        resultsDiv.classList.add('bg-white', 'border-red-500'); 
                        updateStatusUI("é‹ä¼‘ãƒ»è¦‹åˆã‚ã›æƒ…å ±ã‚ã‚Š", "red", false);
                    } else {
                        // é…å»¶ãƒ»ä¹±ã‚Œã®ã¿ã®å ´åˆ
                        resultsDiv.classList.add('bg-white', 'border-yellow-400');
                        updateStatusUI("é…å»¶ãƒ»ä¹±ã‚Œæƒ…å ±ã‚ã‚Š", "orange", false);
                    }
                    
                } else {
                    // ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ±ãŒãªã„å ´åˆ
                    resultsDiv.innerHTML = `<div class="p-3 text-green-700">ç¾åœ¨ã€é‹è¡Œã«å¤§ããªæ”¯éšœã‚’ããŸã™æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆé€šå¸¸ç›£è¦–ï¼‰</div>`;
                    resultsDiv.classList.remove('bg-white', 'border-red-500', 'border-yellow-400');
                    resultsDiv.classList.add('bg-gray-50', 'border-gray-200');
                    updateStatusUI("å¹³å¸¸é‹è»¢", "green", false); 
                }

                // ãŠçŸ¥ã‚‰ã›æ¬„ã®æ›´æ–° (å®šå‹æ–‡ã€å·¥äº‹æƒ…å ±ãªã©)
                if (activeNoticesHtml.length > 0) {
                    // é€šçŸ¥ã‚’è·¯ç·šåã§ã‚½ãƒ¼ãƒˆï¼ˆA-Zé †ï¼‰
                    activeNoticesHtml.sort(); 
                    noticeDiv.innerHTML = activeNoticesHtml.join('');
                    noticeDiv.classList.remove('bg-gray-50', 'border-gray-200');
                    noticeDiv.classList.add('bg-white', 'border-blue-300'); 
                } else {
                    noticeDiv.innerHTML = `<div class="p-3 text-gray-500">ç¾åœ¨ã€å®šå‹çš„ãªãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
                    noticeDiv.classList.remove('bg-white', 'border-blue-300');
                    noticeDiv.classList.add('bg-gray-50', 'border-gray-200');
                }
                

            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã¾ãŸã¯å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                resultsDiv.innerHTML = `<div class="p-3 text-yellow-700">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ (${error.message})</div>`;
                noticeDiv.innerHTML = `<div class="p-3 text-yellow-700">ãŠçŸ¥ã‚‰ã›æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>`;
                updateStatusUI("ã‚¨ãƒ©ãƒ¼", "orange", false);
            }
        }
        
        /**
         * æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãã®ãƒ•ã‚§ãƒƒãƒé–¢æ•°
         */
        async function fetchWithRetry(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.status !== 429) { 
                        return response;
                    }
                    if (i === maxRetries - 1) {
                        return response; 
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000; 
                    console.log(`[API] 429ã‚’æ¤œå‡ºã€‚${delay / 1000}ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    console.warn(`[API] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã€‚ãƒªãƒˆãƒ©ã‚¤ä¸­...`, error.message);
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * UIã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
         */
        function updateStatusUI(text, color, isSpin) {
            const panel = document.getElementById('status-panel');
            const icon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');

            statusText.textContent = text;
            
            // è‰²ã®æ›´æ–°
            panel.className = 'monitor-card rounded-lg p-4 mb-6 transition duration-300 border-l-4'; // ãƒªã‚»ãƒƒãƒˆ
            let borderColor = 'border-gray-400';
            let iconColor = 'text-gray-500';
            
            switch (color) {
                case 'red':
                    borderColor = 'border-red-500';
                    iconColor = 'text-red-500';
                    break;
                case 'green':
                    borderColor = 'border-green-500';
                    iconColor = 'text-green-500';
                    break;
                case 'orange': 
                    borderColor = 'border-yellow-500';
                    iconColor = 'text-yellow-500';
                    break;
                case 'blue': 
                    borderColor = 'border-blue-500';
                    iconColor = 'text-blue-500';
                    break;
                case 'gray':
                default:
                    borderColor = 'border-gray-400';
                    iconColor = 'text-gray-500';
                    break;
            }
            
            panel.classList.add(borderColor);
            icon.classList.remove('text-gray-500', 'text-red-500', 'text-green-500', 'text-yellow-500', 'text-blue-500');
            icon.classList.add(iconColor);

            // ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            if (isSpin) {
                icon.classList.add('animate-spin');
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0l3-3m-3 3l3 3"></path>`;
            } else {
                icon.classList.remove('animate-spin');
                // å®Œäº†ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›´
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
            }
        }

        /**
         * æ¬¡å›æ›´æ–°ã¾ã§ã®æ®‹ã‚Šæ™‚é–“ã‚’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã—ã¾ã™ã€‚
         */
        function updateCountdown() {
            const nextUpdateInfo = document.getElementById('next-update-info');
            if (isMonitoring) {
                // lastUpdateTimeãŒnullã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã€nullã®å ´åˆã¯ç¾åœ¨ã®æ™‚åˆ»ã‚’åŸºæº–ã«ã™ã‚‹
                const baseTime = lastUpdateTime ? lastUpdateTime.getTime() : new Date().getTime() - updateIntervalMs;
                const nextUpdateTimestamp = baseTime + updateIntervalMs;
                const remainingTimeMs = nextUpdateTimestamp - new Date().getTime();
                
                if (remainingTimeMs > 0) {
                    const remainingSeconds = Math.ceil(remainingTimeMs / 1000);
                    nextUpdateInfo.textContent = `æ¬¡å›æ›´æ–°ã¾ã§: ç´„ ${remainingSeconds} ç§’`;
                } else {
                     nextUpdateInfo.textContent = `æ¬¡å›æ›´æ–°ã¾ã§: å‡¦ç†ä¸­...`;
                }
            } else {
                nextUpdateInfo.textContent = 'ç›£è¦–ã¯åœæ­¢ã—ã¦ã„ã¾ã™ã€‚';
            }
        }

        // =================================================================
        // ğŸ”„ ç›£è¦–æ©Ÿèƒ½ã®åˆ¶å¾¡
        // =================================================================
        
        /**
         * ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™ã€‚
         */
        function startMonitoring() {
            if (monitorIntervalId !== null) {
                clearInterval(monitorIntervalId);
            }
            isMonitoring = true;
            document.getElementById('toggle-monitor').textContent = 'ç›£è¦–åœæ­¢';
            document.getElementById('toggle-monitor').classList.remove('bg-green-500', 'hover:bg-green-600');
            document.getElementById('toggle-monitor').classList.add('bg-red-500', 'hover:bg-red-600');

            // åˆå›å®Ÿè¡Œ
            fetchAndUpdateTrainInfo(); 
            // å®šæœŸå®Ÿè¡Œ
            monitorIntervalId = setInterval(fetchAndUpdateTrainInfo, updateIntervalMs);
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã®é–‹å§‹ (1ç§’ã”ã¨)
            setInterval(updateCountdown, 1000); 
            
            console.log(`ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚æ›´æ–°é–“éš”: ${updateIntervalMs / 1000} ç§’`);
        }

        /**
         * ç›£è¦–ã‚’åœæ­¢ã—ã¾ã™ã€‚
         */
        function stopMonitoring() {
            if (monitorIntervalId !== null) {
                clearInterval(monitorIntervalId);
                monitorIntervalId = null;
            }
            isMonitoring = false;
            document.getElementById('toggle-monitor').textContent = 'ç›£è¦–å†é–‹';
            document.getElementById('toggle-monitor').classList.remove('bg-red-500', 'hover:bg-red-600');
            document.getElementById('toggle-monitor').classList.add('bg-green-500', 'hover:bg-green-600');
            document.getElementById('status-text').textContent = 'ç›£è¦–åœæ­¢ä¸­';
            updateStatusUI("ç›£è¦–åœæ­¢ä¸­", "gray", false);
            console.log("ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
        }

        // =================================================================
        // ğŸš€ åˆæœŸè¨­å®šã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            const intervalSelect = document.getElementById('interval-select');
            const toggleButton = document.getElementById('toggle-monitor');
            
            // 1. æ›´æ–°é–“éš”ã®å¤‰æ›´
            intervalSelect.addEventListener('change', (e) => {
                updateIntervalMs = parseInt(e.target.value);
                if (isMonitoring) {
                    stopMonitoring();
                    startMonitoring();
                }
                console.log(`æ›´æ–°é–“éš”ã‚’ ${updateIntervalMs / 1000} ç§’ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`);
            });

            // 2. ç›£è¦–/åœæ­¢ã®åˆ‡ã‚Šæ›¿ãˆ
            toggleButton.addEventListener('click', () => {
                if (isMonitoring) {
                    stopMonitoring();
                } else {
                    startMonitoring();
                }
            });

            // 3. åˆæœŸç›£è¦–é–‹å§‹
            updateIntervalMs = parseInt(intervalSelect.value);
            // lastUpdateTimeã‚’åˆæœŸåŒ– (åˆå›å®Ÿè¡Œã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒå§‹ã¾ã‚‹ã‚ˆã†ã«)
            lastUpdateTime = new Date(new Date().getTime() - updateIntervalMs); 
            startMonitoring();
        });
    </script>
</body>
</html>



